---
import Layout from '../layouts/Layout.astro';
import SeccionDia from '../components/SeccionDia.astro';
import SeccionDiaActual from '../components/SeccionDiaActual.astro';

import dias from '../data/dias.json';
import disenoDias from '../data/disenoDias.json';

// Cambia este índice para ver un día diferente (0 a 7)
const diaActualIndex = 5;
const ahora = new Date();
const horas = 14//ahora.getHours();
const minutos = 10//ahora.getMinutes();
const minutosActuales = horas * 60 + minutos;

const diaActual = dias[diaActualIndex];
const diseno = disenoDias[diaActualIndex];

let procesionesCandidatas = [];

console.log(horas , minutos);

// Agrega procesiones del día actual
procesionesCandidatas.push(...diaActual.procesiones.map(p => ({ ...p, index: diaActualIndex })));

// Agrega procesiones del día anterior que sigan en la calle
if (diaActualIndex > 0) {
  const diaAnterior = dias[diaActualIndex - 1];

  const procesionesEnCurso = diaAnterior.procesiones.filter(p => {
    const [horaLlegada, minLlegada] = p.horaLlegada.split(":").map(Number);
    const llegadaMin = horaLlegada * 60 + minLlegada;

    // Si llega después de la medianoche, y es ahora antes de esa hora
    return llegadaMin < 6 * 60 && minutosActuales <= llegadaMin;
  }).map(p => ({ ...p, index: diaActualIndex - 1 }));

  procesionesCandidatas.push(...procesionesEnCurso);
}

// Busca la más cercana a la hora actual
let indexProcesion = 0;
let minDiferencia = Infinity;
let diaIndexFinal = diaActualIndex;

procesionesCandidatas.forEach((p, i) => {
  const [hora, min] = p.horaSalida.split(":").map(Number);
  const salidaMin = hora * 60 + min;
  const diferencia = Math.abs(salidaMin - minutosActuales);

  if (diferencia < minDiferencia) {
    minDiferencia = diferencia;
    indexProcesion = i;
    diaIndexFinal = p.index;
  }
});

const primeraProcesion = procesionesCandidatas[indexProcesion];

let estaEnCalle = false;

if (primeraProcesion) {
  const [horaSalida, minSalida] = primeraProcesion.horaSalida.split(":").map(Number);
  const [horaLlegada, minLlegada] = primeraProcesion.horaLlegada.split(":").map(Number);

  const salidaMin = horaSalida * 60 + minSalida - 30;
  const llegadaMin = horaLlegada * 60 + minLlegada + 30;

  // Si la llegada es después de medianoche (p.ej. 01:00 = 60 min) y la salida es antes (p.ej. 23:00 = 1380 min)
  // y llega al día siguiente, ajustamos llegada
  const llegadaAjustada = llegadaMin < salidaMin ? llegadaMin + 1440 : llegadaMin;
  const minutosActualesAjustados = minutosActuales < salidaMin ? minutosActuales + 1440 : minutosActuales;

  estaEnCalle = minutosActualesAjustados >= salidaMin && minutosActualesAjustados <= llegadaAjustada;
}


---

<Layout>
  <SeccionDiaActual
    titulo={diseno.nombre}
    imagenNormal={primeraProcesion?.imagenCaratula ?? ''}
    imagenExtendida={primeraProcesion?.imagenExtendida ?? ''}
    posicionImagen={primeraProcesion?.posicionImagen ?? 'center'}
    hermandad={primeraProcesion?.nombre ?? ''}
    iglesia={primeraProcesion?.parroquia ?? ''}
    horaSalida={primeraProcesion?.horaSalida ?? ''}
    horaLlegada={primeraProcesion?.horaLlegada ?? ''}
    posicionTexto={diseno.posicionTexto}
    colorTexto={diseno.colorTexto}
    estaEnCalle={estaEnCalle}
  />

  {dias.map((dia, index) =>
    index >= diaActualIndex && dia.procesiones.length > 0 ? (
      <SeccionDia
        titulo={dia.titulo}
        imagenes={dia.procesiones.map((p) => ({
          src: p.imagenCaratula,
          alt: p.nombre
        }))}
      />
    ) : null
  )}
</Layout>
